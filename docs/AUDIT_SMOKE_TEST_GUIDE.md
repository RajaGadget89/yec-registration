# Audit Smoke Test Guide

## Overview

The audit smoke tests validate the complete audit plumbing end-to-end, ensuring that:

1. **Every API response includes `x-request-id`** generated by the audit wrapper
2. **Access logs are written** to `audit.access_log` with proper correlation
3. **Event logs are written** to `audit.event_log` with `correlation_id = request_id`
4. **Correlation chain integrity** is maintained across all audit logs

## Test Scenarios

### Scenario A: Access Log Validation
- **Endpoint**: `POST /api/test-audit`
- **Purpose**: Validates that API calls generate access logs
- **Validations**:
  - Response includes `x-request-id` header
  - Access log entry appears in `audit.access_log`
  - Required fields: `action`, `resource`, `result`, `latency_ms`, `src_ip`, `user_agent`, `row_hash`

### Scenario B: Event Log Validation
- **Endpoint**: `GET /api/diag/audit-rpc`
- **Purpose**: Validates that diagnostic events generate event logs
- **Validations**:
  - Response includes `x-request-id` header
  - Event log entry appears in `audit.event_log`
  - Required fields: `action`, `resource`, `actor_role`, `result`, `row_hash`
  - Correlation chain: `correlation_id = request_id`

### Scenario C: Registration Flow Audit Validation
- **Endpoint**: `POST /api/register`
- **Purpose**: Validates real business flow audit logging
- **Validations**:
  - Response includes `x-request-id` header
  - Access log entry appears
  - Multiple event logs appear (RegisterSubmitted, RegistrationCreated, StatusChanged)
  - All events have correct correlation chain

## Test Files

### Main Test File
- **Location**: `tests/e2e/audit-smoke.spec.ts`
- **Tag**: `@audit-smoke`
- **Dependencies**: Uses existing helper infrastructure

### Test Runner Script
- **Location**: `tests/e2e/run-audit-smoke.sh`
- **Purpose**: Automated test execution with environment validation
- **Features**: Environment checks, application health check, detailed reporting

### Helper Infrastructure
- **Supabase Client**: `tests/e2e/helpers/supabaseTestClient.ts`
- **Log Polling**: `tests/e2e/helpers/logPoller.ts`
- **Test Data**: `tests/e2e/helpers/testData.ts`

## Environment Requirements

### Required Environment Variables
```bash
BASE_URL=http://localhost:8080                    # Application URL
SUPABASE_URL=https://your-project.supabase.co     # Supabase project URL
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key   # Supabase service role key
```

### Application Requirements
- Application must be running and accessible
- Supabase RPC functions must exist:
  - `log_access` - For access logging
  - `log_event` - For event logging
- Audit tables must exist:
  - `audit.access_log`
  - `audit.event_log`

## Running the Tests

### Quick Test
```bash
# Run smoke tests directly
npx playwright test -g "@audit-smoke"

# Run with custom base URL
BASE_URL=https://your-domain.com npx playwright test -g "@audit-smoke"
```

### Using Test Runner Script
```bash
# Set environment variables
export BASE_URL=http://localhost:8080
export SUPABASE_URL=https://your-project.supabase.co
export SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Run tests
./tests/e2e/run-audit-smoke.sh
```

### Debug Mode
```bash
# Run with debug output
npx playwright test tests/e2e/audit-smoke.spec.ts --debug

# Run specific scenario
npx playwright test tests/e2e/audit-smoke.spec.ts -g "Scenario A"
```

## Test Infrastructure

### Polling Strategy
- **Timeout**: 30 seconds maximum wait time
- **Interval**: 1 second between retries
- **Backoff**: Linear retry strategy
- **Non-blocking**: Tests don't block user responses

### Database Queries
The tests use the following Supabase queries:

```sql
-- Access logs by request_id
SELECT * FROM audit.access_log 
WHERE request_id = 'captured-request-id'
AND occurred_at_utc > now() - interval '10 minutes'
ORDER BY occurred_at_utc DESC;

-- Event logs by correlation_id
SELECT * FROM audit.event_log 
WHERE correlation_id = 'captured-request-id'
AND occurred_at_utc > now() - interval '10 minutes'
ORDER BY occurred_at_utc DESC;
```

### Field Validation
Each test validates the following required fields:

#### Access Log Fields
- `action` - API action (e.g., "api:POST /api/test-audit")
- `resource` - Resource name (e.g., "test-audit")
- `request_id` - Request identifier
- `result` - Success/failure status
- `latency_ms` - Response time in milliseconds
- `src_ip` - Source IP address
- `user_agent` - User agent string
- `row_hash` - Row integrity hash

#### Event Log Fields
- `action` - Event action (e.g., "DiagEvent")
- `resource` - Event resource (e.g., "System")
- `correlation_id` - Correlation identifier (should match request_id)
- `actor_role` - Actor role (e.g., "system", "user", "admin")
- `result` - Success/failure status
- `row_hash` - Row integrity hash

## Troubleshooting

### Common Issues

#### 1. Missing Environment Variables
```
❌ Missing required environment variables:
   - BASE_URL
   - SUPABASE_URL
   - SUPABASE_SERVICE_ROLE_KEY
```
**Solution**: Set all required environment variables before running tests.

#### 2. Application Not Running
```
❌ Application not responding at http://localhost:8080
```
**Solution**: Start the application and ensure it's accessible.

#### 3. Supabase Connection Issues
```
❌ Failed to query access logs: connection error
```
**Solution**: 
- Verify Supabase URL and service role key
- Check network connectivity
- Ensure RPC functions exist

#### 4. Audit Logs Not Appearing
```
❌ Timeout waiting for logs. Found 0 access logs (expected 1)
```
**Solution**:
- Check if audit wrapper is applied to endpoints
- Verify RPC functions are working
- Check database permissions

#### 5. Correlation Chain Mismatch
```
❌ Event log correlation_id doesn't match request_id
```
**Solution**:
- Verify request context is properly set
- Check audit domain handler implementation
- Ensure correlation ID propagation

### Debug Commands

#### Manual API Testing
```bash
# Test access logging
curl -X POST "http://localhost:8080/api/test-audit" \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}' \
  -v

# Test event logging
curl "http://localhost:8080/api/diag/audit-rpc" \
  -v
```

#### Database Verification
```sql
-- Check recent audit logs
SELECT action, resource, request_id, correlation_id,
       occurred_at_utc at time zone 'Asia/Bangkok' as th_time
FROM audit.access_log
ORDER BY occurred_at_utc DESC
LIMIT 10;

-- Check event logs
SELECT action, resource, correlation_id, actor_role,
       occurred_at_utc at time zone 'Asia/Bangkok' as th_time
FROM audit.event_log
ORDER BY occurred_at_utc DESC
LIMIT 10;
```

#### Environment Validation
```bash
# Check environment variables
echo "BASE_URL: $BASE_URL"
echo "SUPABASE_URL: $SUPABASE_URL"
echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:0:10}..."

# Test Supabase connection
curl -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
     -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
     "$SUPABASE_URL/rest/v1/audit.access_log?select=count&limit=1"
```

## Integration with CI/CD

### GitHub Actions Example
```yaml
name: Audit Smoke Tests
on: [push, pull_request]

jobs:
  audit-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Start application
        run: npm run dev &
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          
      - name: Wait for application
        run: sleep 10
        
      - name: Run audit smoke tests
        run: |
          export BASE_URL=http://localhost:8080
          export SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          export SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ./tests/e2e/run-audit-smoke.sh
```

### Local Development
```bash
# Development workflow
npm run dev &                    # Start application
sleep 10                        # Wait for startup
./tests/e2e/run-audit-smoke.sh  # Run tests
```

## Performance Considerations

### Test Performance
- **Total Duration**: ~90 seconds (3 scenarios × 30 seconds each)
- **Polling Overhead**: Minimal impact on application performance
- **Database Load**: Light queries with time-based filtering
- **Concurrency**: Tests run sequentially to avoid interference

### Production Impact
- **Non-blocking**: Audit logging never blocks user responses
- **Fire-and-forget**: Failures don't affect application functionality
- **Resource Usage**: Minimal memory and CPU overhead
- **Network**: Light Supabase API calls

## Security Considerations

### Service Role Key
- **Usage**: Only in Playwright test runner (Node context)
- **Never exposed**: Never sent to browser
- **Scope**: Read-only access to audit logs
- **Rotation**: Follow Supabase security best practices

### PII Safety
- **No PII in tests**: Test data uses dummy values
- **Masked data**: Real PII is masked in audit logs
- **Test isolation**: Each test uses unique identifiers

## Success Criteria

The audit smoke tests are considered successful when:

1. ✅ **All scenarios pass** without errors
2. ✅ **Response headers** include `x-request-id`
3. ✅ **Access logs** appear with correct correlation
4. ✅ **Event logs** appear with `correlation_id = request_id`
5. ✅ **Required fields** are present and valid
6. ✅ **Correlation chain** integrity is maintained
7. ✅ **No secrets** are exposed in browser context
8. ✅ **Failures** provide actionable diagnostics

## Next Steps

After successful smoke test execution:

1. **Monitor Production**: Deploy and monitor audit logs in production
2. **Expand Coverage**: Add more business flow tests as needed
3. **Performance Tuning**: Optimize polling intervals if needed
4. **Alerting**: Set up alerts for audit system failures
5. **Documentation**: Update operational runbooks

---

**Status**: ✅ **IMPLEMENTATION COMPLETE**

The audit smoke tests provide comprehensive validation of the audit system plumbing and are ready for production use.
